<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../polymer/lib/utils/templatize.html">
<link rel="import" href="../polymer/lib/utils/debounce.html">
<link rel="import" href="../polymer/lib/utils/flush.html">

<link rel="import" href="auth-store.html">

<dom-module id="auth-role">
  <template>
    <template is="dom-if" if="[[if]]" restamp="[[restamp]]">
      <slot></slot>
    </template>
  </template>

<script>
(function() {
  'use strict';
  /**
   * `<auth-role>` is a custom 'dom-if' implementation that checks the
   * authentication status and role membership (from the JWT token).
   * Note any of the role membership checks imply `authenticated`.
   *
   * Examples:
   *
   * User must be anonymous (unauthenticated):
   *
   *     <template is="auth-role" anonymous>...</template>
   *
   * User must be authenticated:
   *
   *     <template is="auth-role" authenticated>...</template>
   *
   * User must have 'admin' role:
   *
   *     <template is="auth-role" role="admin">...</template>
   *
   * User must have 'admin' OR operator 'role':
   *
   *     <template is="auth-role" any="['admin', 'operator']">...</template>
   *
   * User must have 'admin' AND 'operator' roles:
   *
   *     <template is="auth-role" all="['admin', 'operator']">...</template>

   * The `<auth-role>` element will stamp a light-dom `<template>` child when
   * the `if` property becomes truthy, and the template can use Polymer
   * data-binding and declarative event features when used in the context of
   * a Polymer element's template.
   *
   * When `if` becomes falsey, the stamped content is hidden but not
   * removed from dom. When `if` subsequently becomes truthy again, the content
   * is simply re-shown. This approach is used due to its favorable performance
   * characteristics: the expense of creating template content is paid only
   * once and lazily.
   *
   * Set the `restamp` property to true to force the stamped content to be
   * created / destroyed when the `if` condition changes.
   *
   * @customElement
   * @polymer
   * @extends Polymer.Element
   * @summary Custom element that conditionally stamps and hides or removes
   *   template content based on authentication status and roles.
   */
  class AuthRole extends Polymer.AuthTokenMixin(Polymer.Element) {
    static get is() { return 'auth-role'; }

    static get properties() {
      return {
        /**
         * Fired whenever DOM is added or removed/hidden by this template (by
         * default, rendering occurs lazily).  To force immediate rendering, call
         * `render`.
         *
         * @event dom-change
         */

        /**
        * When true, this template will stamp if the user is un-authenticated (i.e. anonymous)
        */
        anonymous: {
          type: Boolean,
          value: false
        },

        /**
        * When true, this template will stamp if the use is authenticated (i.e. signed-in)
        * but without requiring any specific roles
        */
        authenticated: {
          type: Boolean,
          value: false
        },

        /**
        * A single role that a user needs to have for this template to be stamped.
        * Implies authenticated.
        */
        role: {
          type: String,
          value: ''
        },

        /**
        * List of any roles that the user needs to have for this template to be stamped.
        * Implies authentication.
        */
        any: {
          type: Array,
          value: function() {
            return [];
          }
        },

        /**
        * List of all roles that the user needs to have for this template to be stamped.
        * Implies authentication.
        */
        all: {
          type: Array,
          value: function() {
            return [];
          }
        },

        /**
         * A boolean indicating whether this template should stamp.
         */
        if: {
          type: Boolean,
          computed: '_computeIf(data, anonymous, authenticated, role, any, all)'
        },

        /**
         * When true, elements will be removed from DOM and discarded when `if`
         * becomes false and re-created and added back to the DOM when `if`
         * becomes true.  By default, stamped elements will be hidden but left
         * in the DOM when `if` becomes false, which is generally results
         * in better performance.
         */
        restamp: {
          type: Boolean,
        }
      }
    }

    _computeIf(data, anonymous, authenticated, role, any, all) {
      if (anonymous && !data) return true;

      if (!data) return false;

      if (authenticated) return true;

      if (role.length > 0) {
        return (data.roles.indexOf(role) !== -1);
      }

      if (any.length > 0) {
        for (var i = 0; i < any.length; i++) {
          for (var j = 0; j < data.roles.length; j++) {
            if (any[i] === data.roles[j]) return true;
          }
        }
        return false;
      }

      if (all.length > 0) {
        for (var i = 0; i < all.length; i++) {
          var ok = false;
          for (var j = 0; j < data.roles.length; j++) {
            if (all[i] === data.roles[j]) {
              ok = true;
              break;
            }
          }
          if (!ok) return false
        }
        return true;
      }

      return false;
    }
  }
  customElements.define(AuthRole.is, AuthRole);
})();
</script>
