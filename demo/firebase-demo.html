<link rel="import" href="../../polymer/polymer-element.html">
<link rel="import" href="../../polymerfire/polymerfire.html">
<link rel="import" href="../../iron-ajax/iron-ajax.html">

<link rel="import" href="../auth-role.html">
<link rel="import" href="../auth-store.html">

<dom-module id="firebase-demo">
  <template>
    <style>
      img {
        max-width: 66px;
      }
      pre {
        word-wrap: break-word;
        white-space: pre-wrap;
        overflow-wrap: break-word;
      }
    </style>

    <firebase-app
        name="captain-codeman"
        api-key="AIzaSyCtTk3qWIdj_kaDTehz0XWYi_C_I0AGchc"
        auth-domain="captain-codeman.firebaseapp.com"
        database-url="https://captain-codeman.firebaseio.com"
        storage-bucket="captain-codeman.appspot.com"
        messaging-sender-id="405985029296">
    </firebase-app>

    <firebase-auth
        id="auth"
        app-name="captain-codeman"
        provider="google"
        user="{{user}}"
        signed-in="{{authenticated}}">
    </firebase-auth>

    <auth-store
      id="store"
      token="[[token]]"
      data="{{jwt}}"
      expiry="{{expiry}}"
      offset="300"
      match="/api">
    </auth-store>

    <button on-click="signin">Signin</button>
    <button on-click="signout">Signout</button>

    <template is="dom-if" if="[[jwt]]">
      <h2>[[jwt.name]]</h2>
      <p><img src$="[[jwt.picture]]"></p>

      <h3>Access Token</h3>
      <p>The custom access token that can be used to authorize API requests</p>
      <pre>[[token]]</pre>

      <h3>Decoded Token</h3>
      <p>The decoded access token showing the custom claims (e.g. roles)</p>
      <pre>[[_json(jwt)]]</pre>

      <h3>Expiry</h3>
      <p>When the token expires</p>
      <p>[[expiry]]</p>

      <h3>Data</h3>
      <p>Result of an iron-ajax call that requires authorization ("operator" role)<p>
      <pre>[[_json(data)]]</pre>

      <iron-ajax
        auth
        auto="[[jwt]]"
        url="https://auth-dot-captain-codeman.appspot.com/api"
        last-response="{{data}}">
      </iron-ajax>
    </template>

    <h3>Role Templates</h3>
    <ul>
      <auth-role restamp anonymous><li>Anonymous</li></auth-role>
      <auth-role restamp authenticated><li>Authenticated</li></auth-role>
      <auth-role restamp role="admin"><li>Admin</li></auth-role>
      <auth-role any='["admin", "operator", "Member"]'><li>Admin or Operator or Member</li></auth-role>
      <auth-role all='["admin", "operator", "Member"]'><li>Admin and Operator and Member</li></auth-role>
    </ul>
  </template>

  <script>
    class FirebaseDemo extends Polymer.Element {
      static get is() { return 'firebase-demo' }

      static get properties() {
        return {
          user: {
            type: Object,
            observer: '_userChanged'
          },

          token: {
            type: String,
          },

          expiry: {
            type: Date
          }
        }
      }

      ready() {
        super.ready()
        this._exchangeTokenBound = this._exchangeToken.bind(this);
        this._signinCustomBound = this._signinCustom.bind(this);
        this.$.store.setTokenRefresh(this._refreshToken.bind(this));
      }

      signin() {
        this.$.auth.signInWithPopup();
      }

      signout() {
        this.$.auth.signOut();
      }

      _refreshToken() {
        console.log('refreshToken calling getToken');
        return this.user.getToken(true);
      }

      _userChanged(newVal, oldVal) {
        if (this.user === null) {
          this.token = null;
        } else {
          this.user.getIdToken(false).then(this._exchangeTokenBound);
        }
      }

      _exchangeToken(token) {
        var data = jwt_decode(token);

        if (data.firebase.sign_in_provider == 'custom') {
          this.token = token;
        } else {
          fetch('https://auth-dot-captain-codeman.appspot.com/token', {
            method: 'GET',
            headers: { Authorization: 'Bearer ' + token },
            mode: 'cors',
            cache: 'default'
          })
          .then(function(response) { return response.text(); })
          .then(this._signinCustomBound);
        }
      }

      _signinCustom(token) {
        this.$.auth.signInWithCustomToken(token);
      }

      _json(val) {
        return JSON.stringify(val, null, '  ');
      }
    }

    window.customElements.define(FirebaseDemo.is, FirebaseDemo);
  </script>
</dom-module>
