<link rel="import" href="../polymer/polymer-element.html">

<script src="../jwt-decode/build/jwt-decode.min.js"></script>

<script>
  (function() {
    'use strict';

    /**
     * `auth-store` enables the app to set the token refresh function
     *
     * @demo demo/index.html
     */
    class AuthStore extends Polymer.Element {
      static get is() { return 'auth-store' }

      static get properties() {
        return {
          // JWT access token
          token: {
            type: String,
            observer: '_tokenChanged'
          },

          // decoded JWT token data
          data: {
            type: Object,
            readOnly: true,
            notify: true,
            observer: '_dataChanged'
          },

          refresh: {
            type: Function,
            value: () => () => Promise.reject('no token refresh function set via <auth-store token-refresh="fn" ...>')
          },

          promise: {
            type: Object,
          },

          // token expiry timestamp
          expiry: {
            type: Date,
            readOnly: true,
            notify: true,
            computed: '_computeExpiry(data)'
          },

          // token expiry offset to allow for clock skew
          offset: {
            type: Number,
            value: 300
          },

          // whether the token is valid
          isValid: {
            type: Boolean,
            readOnly: true,
            notify: true
          },

          subscribers: {
            type: Array,
            value: () => []
          },

          match: {
            type: String,
            value: '.*',
            observer: '_matchChanged'
          }
        }
      }

      static get observers() {
        return [
          '_expiryChanged(expiry, offset)'
        ]
      }

      constructor() {
        super()

        if (AuthStore.instance === undefined) AuthStore.instance = this;
        this.onIronAjaxPresendBound = this.onIronAjaxPresend.bind(this);
      }

      connectedCallback() {
        super.connectedCallback()
        this.setAttribute('hidden', '');
        window.addEventListener('iron-ajax-presend', this.onIronAjaxPresendBound, true)
      }

      disconnectedCallback() {
        super.disconnectedCallback()
        window.removeEventListener('iron-ajax-presend', this.onIronAjaxPresendBound, true)
      }

      register(subscriber) {
        this.subscribers.push(subscriber);
        subscriber._setData(this.data);
      }

      unregister(subscriber) {
        var i = this.subscribers.indexOf(subscriber);
        if (i > -1) this.subscribers.splice(i, 1)
      }

      _dataChanged(data) {
        for(var i = 0; i < this.subscribers.length; i++) {
          this.subscribers[i]._setData(data);
        }
      }

      // set the token refresh function
      setTokenRefresh(fn) {
        this.refresh = this.refreshToken(fn);
      }

      // refresh the access token
      refreshToken(fn) {
        return () => {
          if (this.isValid) {
            return Promise.resolve(this.token);
          }
          return fn().then(token => {
            this.token = token;
            return token;
          });
        };
      }

      // decodes JWT token data and updates instances
      _tokenChanged(newVal, oldVal) {
        var data = this.token ? jwt_decode(this.token) : null;
        this._setData(data);
      }

      // compute the token expiry time from the JWT data
      _computeExpiry(data) {
        if (data === null || typeof data.exp === 'undefined') {
          return null;
        }
        var date = new Date(0);
        date.setUTCSeconds(data.exp);
        return date;
      }

      // set a timeout function to clear the token valid state when expired
      _expiryChanged(expiry, offset) {
        if (this.timeout) window.clearTimeout(this.timeout);
        if (!expiry) return
        var countdown = expiry.valueOf() - new Date().valueOf() - (offset * 1000);
        var seconds = Math.floor(countdown / 1000);
        var minutes = Math.floor(seconds / 60);
        seconds -= minutes * 60;
        console.log('token valid for', minutes + 'm', seconds + 's');

        if (countdown < 0) {
          this._setIsValid(false);
          this._tokenExpired();
        } else {
          this._setIsValid(true);
          this.timeout = window.setTimeout(this._tokenExpired.bind(this), countdown);
        }
      }

      // clear the token valid flag and reset the promise to force a token refresh
      // for any future AJAX auth operations
      _tokenExpired() {
        console.log('token expired');
        this._setIsValid(false);
        this.promise = null;
      }

      _matchChanged(match) {
        this.regex = new RegExp(match, 'i')
      }

      // TODO: add regex filter to control which requests to add header
      onIronAjaxPresend(e) {
        if (e.path[0].getAttribute('auth') === null && !this.regex.test(e.detail.options.url)) return;

        var send = e.detail.request.send.bind(e.detail.request);
        e.detail.request.send = (options) => {
          if (!this.promise) {
            this.promise = this.refresh();
          }
          this.promise.then(token => {
            options.headers['Authorization'] = 'Bearer ' + token;
            send(options);
          });
        };
      }
    }

    window.customElements.define(AuthStore.is, AuthStore);

    /**
     * `Polymer.AuthTokenMixin` provides read-access to the auth token
     *
     * @polymerBehavior Polymer.AuthTokenMixin
     */
    Polymer.AuthTokenMixin = (superclass) => {
      return class extends superclass {
        static get properties() {
          return {
            // decoded JWT token data
            data: {
              type: Object,
              readOnly: true,
              notify: true,
            }
          }
        }

        connectedCallback() {
          super.connectedCallback();
          AuthStore.instance.register(this);
        }

        disconnectedCallback() {
          super.disconnectedCallback();
          AuthStore.instance.unregister(this);
        }
      }
    };

  })();
</script>
